---
import { getLocale } from 'astro-i18n-aut';
import { t, localedURL } from 'src/utils/i18n.ts';
import Grid from 'src/layouts/Grid.astro';
import Block from 'src/components/grid/Block.astro';
import Button from 'src/components/grid/Button.astro';
import { Prepr } from 'src/utils/prepr';
import GetPostBySlug from 'src/queries/get-post-by-slug';
import NotFound from 'src/pages/404.astro';
import Facebook from 'src/components/sharebuttons/Facebook.astro';
import Twitter from 'src/components/sharebuttons/Twitter.astro';
import Linkedin from 'src/components/sharebuttons/Linkedin.astro';
import Telegram from 'src/components/sharebuttons/Telegram.astro';

const url = Astro.url;
const locale = getLocale(url);
const localedData = t(locale).meta;

const response = await Prepr(GetPostBySlug(locale, Astro.params.slug ?? ''));
const { data } = await response.json();
const post = data.Post;
if (post?.body) {
  post.body.map((e: any) => {
    if (e.__typename === 'Text') {
      e.body = e.body.replaceAll('<p', '<p class="indent-8 mb-3" ');
      e.body = e.body.replaceAll(
        '<h2',
        '<h2 class="mb-5 mt-10 text-center text-3xl font-semibold" '
      );
      e.body = e.body.replaceAll(
        '<h3',
        '<h3 class="mb-5 mt-10 text-center text-2xl font-semibold" '
      );
      e.body = e.body.replaceAll(
        '<h4',
        '<h4 class="mb-5 mt-10 text-center text-xl font-semibold" '
      );
      e.body = e.body.replaceAll(
        '<h5',
        '<h5 class="mb-5 mt-10 text-center text-lg font-semibold" '
      );
      e.body = e.body.replaceAll(
        '<h6',
        '<h6 class="mb-5 mt-10 text-center text-base font-semibold" '
      );
      e.body = e.body.replaceAll('<ul', '<ul class="list-disc pl-5" ');
      e.body = e.body.replaceAll('<ol', '<ol class="list-decimal pl-5" ');
      e.body = e.body.replaceAll('<a', '<a class="underline text-cyan-600" ');
      e.body = e.body.replaceAll(
        '<table',
        '<table class="border-collapse border border-slate-500 mt-10 mb-5" '
      );
      e.body = e.body.replaceAll('<th', '<th class="border border-slate-600" ');
      e.body = e.body.replaceAll('<td', '<td class="border border-slate-700" ');
    }
    return e;
  });
}
---

{
  post ? (
    <Grid title={post?.title} description={post?.description} image={post?.image?.url}>
      <Button path={localedURL(locale, '/posts')} title={localedData.posts.back} />
      <Block md lg />
      <Block md lg />
      <Block md lg />
      <Block md lg />
      <Block md lg />
      <Block lg />
      <div class='col-span-2 mb-5 bg-white p-5 md:col-span-4 lg:col-span-6'>
        <div class='flex justify-center'>
          <h1 class='mb-5 border-b-2 border-blue-600 px-2 pb-2 text-center text-3xl font-bold text-blue-600'>
            {post?.title}
          </h1>
        </div>
        {post.body?.map((e: any) => {
          if (e.__typename === 'Text') {
            return <Fragment set:html={e.body} />;
          }
          if (e.__typename === 'Assets') {
            return <img src={e.items[0].url} />;
          }
          return null;
        }) ?? ''}
        <h2 class='mb-5 mt-10 text-center text-3xl font-semibold'>{localedData.posts.share}</h2>
        <div class='flex flex-row justify-center gap-5'>
          <Facebook title={post.title} link={url} />
          <Twitter title={post.title} description={post.description} link={url} />
          <Linkedin link={url} />
          <Telegram link={url} description={post.description} />
        </div>
      </div>
    </Grid>
  ) : (
    <NotFound />
  )
}
